<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<!-- Meta, title, CSS, favicons, etc. -->
	<meta charset="utf-8">
	<title>Turling Robot</title>

	<!-- Bootstrap core CSS -->
	<style class="anchorjs"></style>
	<link href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">

	<!-- Optional Bootstrap Theme -->
	<link href="data:text/css;charset=utf-8," data-href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" rel="stylesheet" id="bs-theme-stylesheet">

	<link href="../assets/css/patch.css" rel="stylesheet">

	<!-- Documentation extras -->

	<link href="../assets/css/docs.min.css" rel="stylesheet">

	<!--[if lt IE 9]><script src="../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
	<script src="../assets/js/ie-emulation-modes-warning.js"></script>
	<style>
		#chatbox {
			border-style: solid;
			border-radius: 2px;
			padding: 40px;
			overflow: scroll;
			height: 450px;
		}
	</style>

	<link rel="icon" href="/favicon.ico">
	<meta charset="utf-8" />
	<title> Turling Robot </title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script>
		try {
			var sock = new WebSocket("ws://{{.}}/sock");
			//sock.binaryType = 'blob'; // can set it to 'blob' or 'arraybuffer
			console.log("Websocket - status: " + sock.readyState);
			sock.onopen = function(m) {
				console.log("CONNECTION opened..." + this.readyState);
			}
			sock.onmessage = function(m) {
				obj = JSON.parse(m.data);
				switch (obj.code) {
					case 100000:
						//	$('#chatbox').append('<blockquote>');
						$('#chatbox').append('<blockquote><p class=text-success>' + obj.text + '</p></blockquote>');
						//$('#chatbox').append('</blockquote>');
						break;
					case 200000:
						$('#chatbox').append('<blockquote><a href="' + obj.url + '" target="_blank" ><p class=text-success>' + obj.text + '</p></a></blockquote>');
						break;
						//Picture;
					case 302000:
						$('#chatbox').append('<blockquote> <p class=text-success>' + obj.text + '</p>');
						var info = ''
						for (var key in obj.list) {
							info += '<a href="' + obj.list[key].detailurl + ' "target="_blank"> <p class=text-success>' + obj.list[key].source + ': ' + obj.list[key].article + '</p></a><br />'
						}
						$('#chatbox').append('<div><blockquote>' + info + '</blockquote></div>');
						break;
						//news
					case 305000:
						$('#chatbox').append('<blockquote><p class=text-success>' + obj.text + '</p>');
						if (obj.list != undefined) {
							var info = ''
							for (var key in obj.list) {
								info += '<div><a href="' + obj.list[key].detailurl + '" target="_blank" > <p class=text-success>' + obj.list[key].trainnum + '</p></a><br />';
								info += '<p class=text-success>' + obj.list[key].start + '发车时间：' + obj.list[key].starttime + '---> ' + obj.list[key].terminal + '结束时间： ' + obj.list[key].endtime + '</p></div><br />';
							}
							$('#chatbox').append('<div><blockquote>' + info + '</blockquote></div>');
						}
						break;
						//trains
					case 306000:
						$('#chatbox').append('<blockquote><p class=text-success>' + obj.text + '</p>');
						if (obj.list != undefined) {
							var info = ''
							for (var key in obj.list) {
								info += '<p class=text-success>' + obj.list[key].flight + ': ' + '发车时间：' + obj.list[key].starttime + '---> ' + '结束时间： ' + obj.list[key].endtime + '</p><br />';
							}
							$('#chatbox').append('<div><blockquote>' + info + '</blockquote></div>');
						}
						break;
						//plains
					case 308000:
						$('#chatbox').append('<blockquote><p class=text-success>' + obj.text + '</p>');
						if (obj.list != undefined) {
							var info = ''
							for (var key in obj.list) {
								info += '<a href="' + obj.list[key].detailurl + '" target="_blank"> ' + obj.list[key].name + '</a><br />';
								info += '<p class=text-success>' + obj.list[key].info + '</p><br />';
							}
							$('#chatbox').append('<div><blockquote>' + info + '</blockquote></div>');
						}
						break;
						//menu
					default:
						info = '<p class=text-danger> Error:' + obj.code + '</p><br /><p class=text-danger>' + obj.text + '</p>'
						$('#chatbox').append('<div><blockquote>' + info + '</blockquote></div>');
						//error
				}
				$('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
			}
			sock.onerror = function(m) {
				console.log("Error occured sending..." + m.data);
			}
			sock.onclose = function(m) {
				console.log("Disconnected - status " + this.readyState);
			}
		} catch (exception) {
			console.log(exception);
		}
	</script>

</head>

<body onLoad="init()">
	<div class="container">
		<div id="chat-box-container" class="col-md-12">
			<h1> Let's talk... </h1>
			<div id="chatbox" scrollTop=scrollHeight>
			</div>

		</div>
		<br />
		<div class="col-md-12">
			<input id="textin" rows="2" placeholder="This is where you type..." class="form-control">
			</input autofocus>
		</div>

	</div>

	<script>
		var geo
		$('#textin').val("");
		// take what's the textbox and send it off

		$('#textin').keydown(function(e) {
			var key = e.which;
			if (key == 13 || (key == 10 && $.browser.msie && $.browser.version <= 6.0)) {
				if (geo == undefined) {
					ask = JSON.stringify({
						Info: $('#textin').val(),
						UserId: id
					})
				} else {
					ask = JSON.stringify({
						Info: $('#textin').val(),
						UserId: id,
						lat: geo.latitude,
						loc: geo.longitude
					})
				}
				sock.send(ask);
				$('#chatbox').append('<blockquote class="blockquote-reverse text-primary">' + $('#textin').val() + '</blockquote>');
				$('#textin').val("");
			}
		});

		function init() {
			id = uuid()
			getLocation()
		}

		function uuid() {
			var s = [];
			var hexDigits = "0123456789abcdef";
			for (var i = 0; i < 16; i++) {
				s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
			}
			var uuid = s.join("");
			return uuid;
		}

		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showLocation);
			} else {
				console.log("Geolocation is not supported by this browser.");
			}
		}

		function showLocation(position) {
			geo = position.coords
		}
	</script>
</body>

</html>
